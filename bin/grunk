#!/usr/bin/env ruby
require 'rubygems'
require 'splunk-sdk-ruby'
require 'json'
require 'getopt/std'

options = Hash.new
options[:time] = false
options[:show_source] = false
options[:max_results] = 30
options[:earliest_time] = '-1d'
options[:latest_time] = 'now'

opt = Getopt::Std.getopts "sdom:f:t:"

if opt["t"]
  options[:latest_time] = opt["t"]
end 

if opt["f"]
  options[:earliest_time] = opt["f"]
end

if opt["s"]
  options[:show_source] = true
end

if opt["d"]
  options[:time] = true
end

if opt["o"]
  options[:show_host] = true
end

if opt["m"]
  options[:max_results] = opt["m"].to_i
end

rc_file = File.new(File.expand_path('~/.splunkrc'), "r")
$config = eval(rc_file.read)

service = Splunk::Service.new $config 
service.login
stream  = service.create_oneshot "search #{ARGV[0]}", max_results: options[:max_results], earliest_time: options[:earliest_time], latest_time: options['latest_time']
results = Splunk::ResultsReader.new stream

results.each do |result|
  print "#{result["_time"]}: " if options[:time]
  if options[:show_host] || options[:show_source]
    print "("
    print result["host"] if options[:show_host]
    print ":" if options[:show_host] && options[:show_source]
    print result["source"] if options[:show_source]
    print ") "
  end
    
  puts result["_raw"]
end
